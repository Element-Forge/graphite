# .github/workflows/validate-conventions.yml
# 
# Validates branch names, commit messages, and PR titles
# Add this to your .github/workflows/ directory

name: Validate Conventions

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }}:refs/remotes/origin/${{ github.base_ref }}

      - name: Validate Branch Name
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "Checking branch: $BRANCH"
          
          # Pattern: <issue-number>-<description>
          if ! [[ "$BRANCH" =~ ^[0-9]+-[a-z0-9]+(-[a-z0-9]+)*$ ]]; then
            echo ""
            echo "=========================================="
            echo " ü§ñ CLAUDE CODE REMINDER"
            echo "=========================================="
            echo ""
            echo " Branch name does not match required format."
            echo ""
            echo " Your branch:     $BRANCH"
            echo " Required format: <issue-number>-<description>"
            echo " Example:         42-add-user-auth"
            echo ""
            echo " Rules:"
            echo "   - Must start with issue number"
            echo "   - Lowercase only"
            echo "   - Hyphens for spaces (no underscores)"
            echo "   - No prefixes (feature/, fix/, etc.)"
            echo ""
            echo "=========================================="
            exit 1
          fi
          
          echo "‚úÖ Branch name is valid"

      - name: Validate Commit Messages
        run: |
          echo "Checking commits..."
          
          COMMITS=$(git log --no-merges --format="%s" origin/${{ github.base_ref }}..HEAD)
          
          FAILED=0
          while IFS= read -r MSG; do
            [ -z "$MSG" ] && continue
            
            # Check for colon after issue number
            if [[ "$MSG" =~ ^#[0-9]+: ]]; then
              echo "‚ùå Colon after issue number: $MSG"
              FAILED=1
              continue
            fi
            
            # Check for uppercase (allowing proper nouns is hard to validate, so we just check first letter)
            if [[ "$MSG" =~ ^#[0-9]+\ [A-Z] ]]; then
              echo "‚ùå Should be lowercase: $MSG"
              FAILED=1
              continue
            fi
            
            # Check for trailing period
            if [[ "$MSG" =~ \.$ ]]; then
              echo "‚ùå No trailing period: $MSG"
              FAILED=1
              continue
            fi
            
            # Check basic format
            if ! [[ "$MSG" =~ ^#[0-9]+\  ]]; then
              echo "‚ùå Must start with #<issue>: $MSG"
              FAILED=1
              continue
            fi
            
            echo "‚úÖ $MSG"
          done <<< "$COMMITS"
          
          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "=========================================="
            echo " ü§ñ CLAUDE CODE REMINDER"
            echo "=========================================="
            echo ""
            echo " Required format: #<issue> <lowercase description>"
            echo " Example:         #42 add user authentication"
            echo ""
            echo "=========================================="
            exit 1
          fi

      - name: Validate PR Title
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          echo "Checking PR title: $TITLE"
          
          # Check for colon after issue number
          if [[ "$TITLE" =~ ^#[0-9]+: ]]; then
            echo ""
            echo "=========================================="
            echo " ü§ñ CLAUDE CODE REMINDER"
            echo "=========================================="
            echo ""
            echo " PR title has colon after issue number."
            echo ""
            echo " Your title:      $TITLE"
            echo " Required format: #<issue> <Title Case>"
            echo " Example:         #42 Add User Authentication"
            echo ""
            echo "=========================================="
            exit 1
          fi
          
          # Check basic format (must start with #<number>)
          if ! [[ "$TITLE" =~ ^#[0-9]+\  ]]; then
            echo ""
            echo "=========================================="
            echo " ü§ñ CLAUDE CODE REMINDER"
            echo "=========================================="
            echo ""
            echo " PR title must start with issue number."
            echo ""
            echo " Your title:      $TITLE"
            echo " Required format: #<issue> <Title Case>"
            echo " Example:         #42 Add User Authentication"
            echo ""
            echo "=========================================="
            exit 1
          fi
          
          # Check for Title Case (first letter after issue should be uppercase)
          if ! [[ "$TITLE" =~ ^#[0-9]+\ [A-Z] ]]; then
            echo ""
            echo "=========================================="
            echo " ü§ñ CLAUDE CODE REMINDER"
            echo "=========================================="
            echo ""
            echo " PR title should be in Title Case."
            echo ""
            echo " Your title:      $TITLE"
            echo " Required format: #<issue> <Title Case>"
            echo " Example:         #42 Add User Authentication"
            echo ""
            echo "=========================================="
            exit 1
          fi
          
          echo "‚úÖ PR title is valid"

      - name: Check PR Body Contains Closes
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          if ! echo "$PR_BODY" | grep -qiE "(closes|fixes|resolves) #[0-9]+"; then
            echo ""
            echo "=========================================="
            echo " ü§ñ CLAUDE CODE REMINDER"
            echo "=========================================="
            echo ""
            echo " PR description must include 'Closes #<issue>'"
            echo ""
            echo " This auto-closes the issue when the PR is merged."
            echo ""
            echo "=========================================="
            exit 1
          fi
          
          echo "‚úÖ PR body contains issue reference"
      - name: Validate .gitignore
        run: |
          errors=()

          # Check .gitignore exists
          if [[ ! -f .gitignore ]]; then
            echo "::error::.gitignore file not found"
            exit 1
          fi
          echo "‚úì .gitignore file exists"

          # Check only one .gitignore exists
          gitignore_files=$(find . -name '.gitignore' -not -path './.git/*')
          count=$(echo "$gitignore_files" | wc -l)
          if [[ $count -gt 1 ]]; then
            errors+=("Found multiple .gitignore files. Only one root .gitignore is allowed:")
            errors+=("$gitignore_files")
          else
            echo "‚úì Only one .gitignore file exists"
          fi

          # Check for trailing whitespace
          if grep -qn '[[:space:]]$' .gitignore; then
            while IFS=: read -r line_num content; do
              errors+=("Line $line_num: Trailing whitespace found: '$content'")
            done < <(grep -n '[[:space:]]$' .gitignore)
          else
            echo "‚úì No trailing whitespace found"
          fi

          # Check for duplicate entries
          duplicates=$(grep -v '^#' .gitignore | grep -v '^[[:space:]]*$' | sort | uniq -d)
          if [[ -n "$duplicates" ]]; then
            errors+=("Found duplicate entries: $duplicates")
          else
            echo "‚úì No duplicate entries found"
          fi

          # Check all entries start with /
          line_num=0
          while IFS= read -r line || [[ -n "$line" ]]; do
            ((line_num++))
            [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
            if [[ ! "$line" =~ ^!?/ ]]; then
              errors+=("Line $line_num: Entry must start with '/': $line")
            fi
          done < .gitignore
          if [[ ${#errors[@]} -eq 0 ]] || ! printf '%s\n' "${errors[@]}" | grep -q "must start with"; then
            echo "‚úì All entries start with /"
          fi

          # Check directories end with /
          line_num=0
          while IFS= read -r line || [[ -n "$line" ]]; do
            ((line_num++))
            [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
            pattern="${line#!}"
            [[ "$pattern" =~ \* ]] && continue
            check_path="${pattern#/}"
            if [[ -d "$check_path" && ! "$line" =~ /$ ]]; then
              errors+=("Line $line_num: Directory entry must end with '/': $line")
            fi
          done < .gitignore
          echo "‚úì Directory entries checked"

          # Check entries are sorted alphabetically
          patterns=$(grep -v '^#' .gitignore | grep -v '^[[:space:]]*$')
          sorted=$(echo "$patterns" | LC_ALL=C sort -f)
          if [[ "$patterns" != "$sorted" ]]; then
            errors+=("Entries are not sorted alphabetically. Expected order:")
            errors+=("$sorted")
          else
            echo "‚úì All entries are sorted alphabetically"
          fi

          # Report errors
          if [[ ${#errors[@]} -gt 0 ]]; then
            echo ""
            echo "::error::Validation failed with ${#errors[@]} error(s):"
            for err in "${errors[@]}"; do
              echo "  - $err"
            done
            exit 1
          fi

          # Summary
          echo ""
          echo "## .gitignore Validation Summary" >> $GITHUB_STEP_SUMMARY
          total_lines=$(wc -l < .gitignore)
          pattern_lines=$(grep -cv '^#\|^[[:space:]]*$' .gitignore || true)
          comment_lines=$(grep -c '^#' .gitignore || true)
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total lines | $total_lines |" >> $GITHUB_STEP_SUMMARY
          echo "| Patterns | $pattern_lines |" >> $GITHUB_STEP_SUMMARY
          echo "| Comments | $comment_lines |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Rules Validated" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Only one .gitignore file in repository" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ All entries start with \`/\`" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ All directories end with \`/\`" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ All entries sorted alphabetically" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ No duplicate entries" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ No trailing whitespace" >> $GITHUB_STEP_SUMMARY